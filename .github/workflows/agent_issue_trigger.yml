# .github/workflows/agent_issue_trigger.yml

name: Agent: Run Task 9 on Issue Label

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  run-agent:
    if: contains(join(github.event.issue.labels.*.name, ','), 'agent-run')
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Prepare environment
        run: |
          # Hardcode Task 9 as specified in TASKS.md
          TASK_ID=9
          TASK_TITLE="Test Agent Automation"
          BRANCH_NAME="agent/task-${TASK_ID}"

          echo "TASK_ID=${TASK_ID}" >> $GITHUB_ENV
          echo "TASK_TITLE=${TASK_TITLE}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: 3. Perform task actions
        run: |
          echo "AGENT: Creating output file for Task ${TASK_ID}"
          echo "# Task ${TASK_ID} Output" > ./task_${TASK_ID}_output.md
          echo "This file was generated by the autonomous agent." >> ./task_${TASK_ID}_output.md

          echo "AGENT: Updating TASKS.md status for Task ${TASK_ID}"
          # Replace exact line starting with "9) - " to mark as In Progress
          sed -i "s/^${TASK_ID}) - .*/${TASK_ID}) ~ ${TASK_TITLE}/" TASKS.md

      - name: 4. Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(agent): Complete Task ${{ env.TASK_ID }} - ${{ env.TASK_TITLE }}"
          branch: ${{ env.BRANCH_NAME }}
          delete-branch: true
          title: "Agent PR for Task ${{ env.TASK_ID }}: ${{ env.TASK_TITLE }}"
          body: |
            This PR was automatically generated by the autonomous agent to complete Task #${{ env.TASK_ID }}.

            ## Task Description
            > This is a test task for the GitHub Actions workflow to pick up.

            ## Acceptance Criteria Checklist
            - [x] The agent creates a file named `task_${{ env.TASK_ID }}_output.md`.
            - [x] The agent opens a PR.
            - [x] The status of Task ${{ env.TASK_ID }} is updated in `TASKS.md`.
          labels: |
            automated-pr
            agent